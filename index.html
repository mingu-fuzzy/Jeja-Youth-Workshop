<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>실시간 변동 현황</title>

  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      margin: 0;
      padding: 16px;
    }

    .top {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      flex-wrap: wrap;
    }

    .meta { color: #666; font-size: 12px; }
    .err { color: #b00020; font-size: 12px; white-space: pre-wrap; }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 12px;
      table-layout: fixed;
      border: 3px solid #333; /* 바깥 테두리 */
    }

    th, td {
      border: 1px solid #e5e5e5;
      padding: 10px 8px;
      text-align: center;
      background: #fff;
    }

    /* 헤더(1행): sticky + 굵은 구분선(사라지지 않게 box-shadow 사용) */
    thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #fff;
      border-bottom: 0; /* border로 굵은 줄 만들지 않음 */
      box-shadow: inset 0 -3px 0 #333; /* 굵은 가로선 */
    }

    /* 번호 열(헤더+바디): 굵은 세로선 */
    th:first-child,
    td.num {
      border-right: 3px solid #333;
      font-weight: 600;
      color: #111;
      width: 56px;
      background: #fff;
    }

    /* 폭탄 */
    td.bomb,
    .bomb {
      color: black;
      font-weight: 700;
      background-color: #ffe5cc; /* 연주황 파스텔 */
    }

    /* 교환 */
    td.exchange,
    .exchange {
      color: black;
      font-weight: 700;
      background-color: #e6f4d7; /* 연두 파스텔 */
    }

    /* 부호 */
    .plus { color: red; font-weight: 700; }
    .minus { color: blue; font-weight: 700; }
  </style>
</head>

<body>
  <div class="top">
    <h2 style="margin:0">실시간 변동 현황</h2>
    <div>
      <div class="meta" id="meta">로딩 중...</div>
      <div class="err" id="err"></div>
    </div>
  </div>

  <div id="root"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzuxPskGqktzoJbVRDZ7e-EWfIA9uIH6M5HlVfE2GR6GSKmcpqiHPnAEIb1lxFEnr2ioQ/exec";
    const API_TOKEN = "mkws_2026_4pK9Qw7xV2nH8dR3aL1c";
    const POLL_MS = 3000;

    let tableEl = null;
    let fixedRows = null;
    let lastCells = null;
    let lastCls = null;

    let timer = null;
    let badCount = 0;
    let inFlight = false;

    function setMeta(msg) { document.getElementById("meta").textContent = msg; }
    function setErr(msg) { document.getElementById("err").textContent = msg || ""; }

    function makeUrl() {
      const sep = API_URL.includes("?") ? "&" : "?";
      return API_URL + sep + "token=" + encodeURIComponent(API_TOKEN) + "&t=" + Date.now();
    }

    function isShapeStable(header, rows) {
      if (!Array.isArray(header) || header.length !== 5) return false;
      if (!Array.isArray(rows)) return false;
      for (const r of rows) {
        if (!Array.isArray(r) || r.length !== 5) return false;
      }
      return true;
    }

    function buildFixedTable(header, rowCount) {
      const root = document.getElementById("root");
      root.innerHTML = "";

      const t = document.createElement("table");
      const thead = document.createElement("thead");
      const tbody = document.createElement("tbody");

      const trh = document.createElement("tr");
      header.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h ?? "";
        trh.appendChild(th);
      });
      thead.appendChild(trh);

      for (let r = 0; r < rowCount; r++) {
        const tr = document.createElement("tr");
        for (let c = 0; c < header.length; c++) {
          const td = document.createElement("td");
          if (c === 0) td.className = "num";
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      t.appendChild(thead);
      t.appendChild(tbody);
      root.appendChild(t);
      tableEl = t;

      lastCells = Array.from({ length: rowCount }, () => Array.from({ length: header.length }, () => ""));
      lastCls = Array.from({ length: rowCount }, () => Array.from({ length: header.length }, () => ""));
      for (let r = 0; r < rowCount; r++) lastCls[r][0] = "num";
    }

    function updateHeader(header) {
      const trh = tableEl.tHead.rows[0];
      for (let c = 0; c < header.length; c++) {
        const v = header[c] ?? "";
        if (trh.cells[c].textContent !== v) trh.cells[c].textContent = v;
      }
    }

    function clsForCell(c, value) {
      if (c === 0) return "num";
      if (value === "폭탄") return "bomb";
      if (value === "교환") return "exchange";
      return "";
    }

    function escapeHtml_(s) {
      return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function colorizeText(text) {
      let t = escapeHtml_(text);

      t = t.replace(/폭탄/g, '<span class="bomb">폭탄</span>');
      t = t.replace(/교환/g, '<span class="exchange">교환</span>');
      t = t.replace(/\+/g, '<span class="plus">+</span>');
      t = t.replace(/-/g, '<span class="minus">-</span>');

      return t;
    }

    function updateRows(rows, colCount) {
      const tbody = tableEl.tBodies[0];

      for (let r = 0; r < fixedRows; r++) {
        const tr = tbody.rows[r];
        const row = rows[r];
        if (!row) continue;

        for (let c = 0; c < colCount; c++) {
          const td = tr.cells[c];
          const newText = (row[c] ?? "").toString();
          const oldText = lastCells[r][c];

          if (newText !== oldText) {
            if (c === 0) td.textContent = newText;
            else td.innerHTML = colorizeText(newText);
            lastCells[r][c] = newText;
          }

          const newCls = clsForCell(c, newText);
          const oldCls = lastCls[r][c];
          if (newCls !== oldCls) {
            td.className = newCls || (c === 0 ? "num" : "");
            lastCls[r][c] = newCls;
          }
        }
      }
    }

    async function poll() {
      if (inFlight) return;
      inFlight = true;

      try {
        const res = await fetch(makeUrl(), { cache: "no-store" });
        const json = await res.json();

        if (!json || !json.ok) {
          badCount++;
          setErr("API 오류: " + (json?.error || "unknown") + "\n누적: " + badCount);
          return;
        }

        const header = (json.header || []).map(x => String(x ?? ""));
        const rows = (json.rows || []).map(r => (r || []).map(x => String(x ?? "")));

        if (!isShapeStable(header, rows)) {
          badCount++;
          setErr("형식 오류: header/rows 모양이 예상과 다릅니다.\n누적: " + badCount);
          return;
        }

        if (!tableEl || fixedRows === null) {
          fixedRows = rows.length;
          buildFixedTable(header, fixedRows);
        }

        const minRows = Math.floor(fixedRows * 0.9);
        if (rows.length < minRows) {
          badCount++;
          setErr("갱신 보류: 부분 데이터로 보입니다.\n받은 행: " + rows.length + " / 기대 행: " + fixedRows + "\n누적: " + badCount);
          return;
        }

        badCount = 0;
        setErr("");

        updateHeader(header);
        updateRows(rows, header.length);

        const stamp = json.updatedAt ? (" / 데이터: " + json.updatedAt) : "";
        setMeta("마지막 갱신: " + new Date().toLocaleString("ko-KR") + stamp);
      } catch (e) {
        badCount++;
        setErr("갱신 실패: " + (e?.message || e) + "\n누적: " + badCount);
      } finally {
        inFlight = false;
      }
    }

    function start(ms) {
      if (timer) clearInterval(timer);
      poll();
      timer = setInterval(poll, ms);
    }

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) start(15000);
      else start(POLL_MS);
    });

    start(POLL_MS);
  </script>
</body>
</html>

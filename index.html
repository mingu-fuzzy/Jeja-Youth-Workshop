<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>실시간 변동 현황</title>

  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      margin: 0;
      padding: 16px;
    }

    .top {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      flex-wrap: wrap;
    }

    .meta { color: #666; font-size: 12px; }
    .err { color: #b00020; font-size: 12px; white-space: pre-wrap; }

    /* ===== 테이블 기본 ===== */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 12px;
      table-layout: fixed;
      border: 3px solid #333;            /* 바깥 테두리 */
    }

    th, td {
      border: 1px solid #e5e5e5;
      padding: 10px 8px;
      text-align: center;
    }

    /* ===== 헤더(1행) ===== */
    thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1;
      border-bottom: 3px solid #333;     /* 1행 굵은 구분선 */
    }

    /* ===== 번호 열 ===== */
    th:first-child,
    td.num {
      border-right: 3px solid #333;      /* 번호 열 굵은 구분선 */
      font-weight: 600;
      color: #111;
      width: 56px;
      background: #fff;
    }

    /* ===== 색상 규칙 ===== */

    /* 폭탄 */
    td.bomb,
    .bomb {
      color: black;
      font-weight: 700;
      background-color: #ffe5cc;         /* 연주황 파스텔 */
    }

    /* 교환 */
    td.exchange,
    .exchange {
      color: black;
      font-weight: 700;
      background-color: #e6f4d7;         /* 연두 파스텔 */
    }

    /* 부호 */
    .plus { color: red; font-weight: 700; }
    .minus { color: blue; font-weight: 700; }
  </style>
</head>

<body>
  <div class="top">
    <h2 style="margin:0">실시간 변동 현황</h2>
    <div>
      <div class="meta" id="meta">로딩 중...</div>
      <div class="err" id="err"></div>
    </div>
  </div>

  <div id="root"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzuxPskGqktzoJbVRDZ7e-EWfIA9uIH6M5HlVfE2GR6GSKmcpqiHPnAEIb1lxFEnr2ioQ/exec";
    const API_TOKEN = "mkws_2026_4pK9Qw7xV2nH8dR3aL1c";
    const POLL_MS = 3000;

    let tableEl = null;
    let fixedRows = null;
    let lastCells = null;
    let lastCls = null;
    let inFlight = false;

    function makeUrl() {
      const sep = API_URL.includes("?") ? "&" : "?";
      return API_URL + sep + "token=" + encodeURIComponent(API_TOKEN) + "&t=" + Date.now();
    }

    function buildFixedTable(header, rowCount) {
      const root = document.getElementById("root");
      root.innerHTML = "";

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const tbody = document.createElement("tbody");

      const trh = document.createElement("tr");
      header.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trh.appendChild(th);
      });
      thead.appendChild(trh);

      for (let r = 0; r < rowCount; r++) {
        const tr = document.createElement("tr");
        for (let c = 0; c < header.length; c++) {
          const td = document.createElement("td");
          if (c === 0) td.className = "num";
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      table.appendChild(thead);
      table.appendChild(tbody);
      root.appendChild(table);

      tableEl = table;
      fixedRows = rowCount;
      lastCells = Array.from({ length: rowCount }, () => Array(header.length).fill(""));
      lastCls = Array.from({ length: rowCount }, () => Array(header.length).fill(""));
    }

    function clsForCell(c, value) {
      if (c === 0) return "num";
      if (value === "폭탄") return "bomb";
      if (value === "교환") return "exchange";
      return "";
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function colorizeText(text) {
      let t = escapeHtml(text);
      t = t.replace(/폭탄/g, '<span class="bomb">폭탄</span>');
      t = t.replace(/교환/g, '<span class="exchange">교환</span>');
      t = t.replace(/\+/g, '<span class="plus">+</span>');
      t = t.replace(/-/g, '<span class="minus">-</span>');
      return t;
    }

    function updateRows(rows) {
      const tbody = tableEl.tBodies[0];

      for (let r = 0; r < fixedRows; r++) {
        if (!rows[r]) continue;
        const tr = tbody.rows[r];

        for (let c = 0; c < rows[r].length; c++) {
          const td = tr.cells[c];
          const newText = String(rows[r][c] ?? "");
          const oldText = lastCells[r][c];

          if (newText !== oldText) {
            if (c === 0) td.textContent = newText;
            else td.innerHTML = colorizeText(newText);
            lastCells[r][c] = newText;
          }

          const newCls = clsForCell(c, newText);
          if (newCls !== lastCls[r][c]) {
            td.className = newCls || (c === 0 ? "num" : "");
            lastCls[r][c] = newCls;
          }
        }
      }
    }

    async function poll() {
      if (inFlight) return;
      inFlight = true;

      try {
        const res = await fetch(makeUrl(), { cache: "no-store" });
        const json = await res.json();
        if (!json.ok) throw new Error("API error");

        if (!tableEl) buildFixedTable(json.header, json.rows.length);
        updateRows(json.rows);

        document.getElementById("meta").textContent =
          "마지막 갱신: " + new Date().toLocaleString("ko-KR");
        document.getElementById("err").textContent = "";
      } catch (e) {
        document.getElementById("err").textContent = "갱신 실패: " + e.message;
      } finally {
        inFlight = false;
      }
    }

    poll();
    setInterval(poll, POLL_MS);
  </script>
</body>
</html>
